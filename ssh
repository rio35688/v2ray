#!/bin/bash
# ==================================================
# V2Ray Manager - SSH Management
# Ù‚Ø§Ø¦Ù…Ø© Ù…ØªÙƒØ§Ù…Ù„Ø© Ù„Ø¥Ø¯Ø§Ø±Ø© SSH
# ==================================================

# Ø§Ù„Ø£Ù„ÙˆØ§Ù†
R='\033[1;31m'
G='\033[1;32m'
Y='\033[1;33m'
B='\033[1;34m'
P='\033[1;35m'
C='\033[1;36m'
W='\033[1;37m'
NC='\033[0m'

if [[ $EUID -ne 0 ]]; then
   echo -e "${R}âŒ ÙŠØ¬Ø¨ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³ÙƒØ±ÙŠØ¨Øª Ø¨ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø±ÙˆØª${NC}"
   exit 1
fi

# ==================================================
# Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø©
# ==================================================
show_banner() {
    clear
    PORT=$(grep -E "^Port" /etc/ssh/sshd_config | awk '{print $2}' || echo "22")
    USERS=$(who | wc -l)
    ROOT=$(grep "^PermitRootLogin" /etc/ssh/sshd_config | awk '{print $2}')
    
    echo -e "${P}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${P}â•‘     ${W}ğŸ” V2Ray Manager - Ø¥Ø¯Ø§Ø±Ø© SSH Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©${P}               â•‘${NC}"
    echo -e "${P}â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£${NC}"
    echo -e "${P}â•‘${NC}  ${C}Ø§Ù„Ù…Ù†ÙØ°:${NC} ${G}$PORT${NC}  |  ${C}Ø§Ù„Ù…ØªØµÙ„ÙˆÙ†:${NC} ${Y}$USERS${NC}"
    echo -e "${P}â•‘${NC}  ${C}Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø±ÙˆØª:${NC} $( [[ "$ROOT" == "yes" ]] && echo "${G}Ù…ÙØ¹Ù„${NC}" || echo "${R}Ù…Ø¹Ø·Ù„${NC}")"
    echo -e "${P}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
}

press_enter() {
    echo ""
    read -p "Ø§Ø¶ØºØ· Enter Ù„Ù„Ø¹ÙˆØ¯Ø©..."
}

show_success() {
    echo -e "${G}âœ… $1${NC}"
}

show_error() {
    echo -e "${R}âŒ $1${NC}"
}

show_warning() {
    echo -e "${Y}âš ï¸ $1${NC}"
}

# ==================================================
# Ø¥Ø¯Ø§Ø±Ø© Ø®Ø¯Ù…Ø© SSH
# ==================================================
ssh_service_menu() {
    while true; do
        show_banner
        echo -e "${P}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
        echo -e "${P}â•‘           ğŸ“Š Ø¥Ø¯Ø§Ø±Ø© Ø®Ø¯Ù…Ø© SSH                    â•‘${NC}"
        echo -e "${P}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo ""
        
        echo -e "  ${G}[1]${NC} ğŸ“‹ Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© SSH"
        echo -e "  ${G}[2]${NC} â–¶ï¸ ØªØ´ØºÙŠÙ„ SSH"
        echo -e "  ${G}[3]${NC} â¹ï¸ Ø¥ÙŠÙ‚Ø§Ù SSH"
        echo -e "  ${G}[4]${NC} ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ SSH"
        echo -e "  ${R}[0]${NC} ğŸ”™ Ø±Ø¬ÙˆØ¹"
        echo ""
        read -p "$(echo -e ${Y}"Ø§Ø®ØªØ± Ø±Ù‚Ù… Ø§Ù„Ø®ÙŠØ§Ø±: "${NC})" choice
        
        case $choice in
            1)
                echo ""
                systemctl status sshd --no-pager -l 2>/dev/null || systemctl status ssh --no-pager -l
                press_enter
                ;;
            2)
                systemctl start sshd 2>/dev/null || systemctl start ssh
                show_success "ØªÙ… ØªØ´ØºÙŠÙ„ SSH"
                press_enter
                ;;
            3)
                show_warning "Ø¥ÙŠÙ‚Ø§Ù SSH Ø³ÙŠÙ…Ù†Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©"
                read -p "Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ (y/n): " confirm
                if [[ "$confirm" == "y" ]]; then
                    systemctl stop sshd 2>/dev/null || systemctl stop ssh
                    show_success "ØªÙ… Ø¥ÙŠÙ‚Ø§Ù SSH"
                fi
                press_enter
                ;;
            4)
                systemctl restart sshd 2>/dev/null || systemctl restart ssh
                show_success "ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ SSH"
                press_enter
                ;;
            0) break ;;
            *) show_error "Ø®ÙŠØ§Ø± ØºÙŠØ± ØµØ§Ù„Ø­"; sleep 1 ;;
        esac
    done
}

# ==================================================
# ØªØºÙŠÙŠØ± Ø¨ÙˆØ±Øª SSH
# ==================================================
change_ssh_port() {
    show_banner
    echo -e "${P}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${P}â•‘           ğŸ”‘ ØªØºÙŠÙŠØ± Ø¨ÙˆØ±Øª SSH                    â•‘${NC}"
    echo -e "${P}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    
    CURRENT=$(grep -E "^Port" /etc/ssh/sshd_config | awk '{print $2}')
    echo -e "${C}Ø§Ù„Ø¨ÙˆØ±Øª Ø§Ù„Ø­Ø§Ù„ÙŠ:${NC} ${G}$CURRENT${NC}"
    show_warning "ØªØºÙŠÙŠØ± Ø§Ù„Ø¨ÙˆØ±Øª Ù‚Ø¯ ÙŠÙ‚Ø·Ø¹ Ø§ØªØµØ§Ù„Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ"
    echo ""
    
    read -p "Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨ÙˆØ±Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯ (1-65535): " NEW_PORT
    
    if [[ "$NEW_PORT" =~ ^[0-9]+$ ]] && [ "$NEW_PORT" -ge 1 ] && [ "$NEW_PORT" -le 65535 ]; then
        # Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ
        cp /etc/ssh/sshd_config /etc/ssh/sshd_config.backup.$(date +%Y%m%d)
        
        # ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙˆØ±Øª
        if grep -q "^Port" /etc/ssh/sshd_config; then
            sed -i "s/^Port [0-9]*/Port $NEW_PORT/" /etc/ssh/sshd_config
        else
            echo "Port $NEW_PORT" >> /etc/ssh/sshd_config
        fi
        
        # ÙØªØ­ Ø§Ù„Ø¨ÙˆØ±Øª ÙÙŠ Ø§Ù„ÙØ§ÙŠØ±ÙˆÙˆÙ„
        if command -v ufw &> /dev/null; then
            ufw allow "$NEW_PORT/tcp" > /dev/null 2>&1
            echo -e "${G}   âœ… ØªÙ… ÙØªØ­ Ø§Ù„Ø¨ÙˆØ±Øª $NEW_PORT ÙÙŠ UFW${NC}"
        fi
        
        # Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ SSH
        systemctl restart sshd 2>/dev/null || systemctl restart ssh
        show_success "ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø¨ÙˆØ±Øª Ø¥Ù„Ù‰ $NEW_PORT"
        show_warning "Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¨ÙˆØ±Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙÙŠ Ø§ØªØµØ§Ù„Ùƒ Ø§Ù„Ù‚Ø§Ø¯Ù…"
    else
        show_error "Ø¨ÙˆØ±Øª ØºÙŠØ± ØµØ§Ù„Ø­"
    fi
    
    press_enter
}

# ==================================================
# Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
# ==================================================
user_management() {
    while true; do
        show_banner
        echo -e "${P}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
        echo -e "${P}â•‘           ğŸ‘¤ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†                  â•‘${NC}"
        echo -e "${P}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo ""
        
        echo -e "  ${G}[1]${NC} ğŸ“‹ Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†"
        echo -e "  ${G}[2]${NC} ğŸ‘¥ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù†Ø´Ø·ÙŠÙ†"
        echo -e "  ${G}[3]${NC} â• Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯"
        echo -e "  ${G}[4]${NC} ğŸ—‘ï¸ Ø­Ø°Ù Ù…Ø³ØªØ®Ø¯Ù…"
        echo -e "  ${G}[5]${NC} ğŸ”‘ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±"
        echo -e "  ${G}[6]${NC} ğŸ”’ Ø­Ø¸Ø± Ù…Ø³ØªØ®Ø¯Ù…"
        echo -e "  ${G}[7]${NC} ğŸ”“ ÙÙƒ Ø­Ø¸Ø± Ù…Ø³ØªØ®Ø¯Ù…"
        echo -e "  ${R}[0]${NC} ğŸ”™ Ø±Ø¬ÙˆØ¹"
        echo ""
        read -p "$(echo -e ${Y}"Ø§Ø®ØªØ± Ø±Ù‚Ù… Ø§Ù„Ø®ÙŠØ§Ø±: "${NC})" choice
        
        case $choice in
            1)
                echo -e "\n${C}Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†:${NC}"
                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                awk -F: '$3>=1000 {printf "ğŸ‘¤ %-15s | UID: %-5s | Shell: %s\n", $1, $3, $7}' /etc/passwd | sort
                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                TOTAL=$(awk -F: '$3>=1000' /etc/passwd | wc -l)
                echo -e "Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${G}$TOTAL${NC}"
                press_enter
                ;;
            2)
                echo -e "\n${C}Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù†Ø´Ø·ÙŠÙ†:${NC}"
                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                if [ $(who | wc -l) -eq 0 ]; then
                    echo "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù†Ø´Ø·ÙŠÙ†"
                else
                    who | awk '{printf "ğŸ‘¤ %-10s | Ù…Ù† %-15s | Ù…Ù†Ø° %s %s\n", $1, $5, $3, $4}'
                fi
                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                ACTIVE=$(who | wc -l)
                echo -e "Ø§Ù„Ù…ØªØµÙ„ÙŠÙ†: ${G}$ACTIVE${NC}"
                press_enter
                ;;
            3)
                echo -e "\n${C}â• Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯${NC}"
                read -p "Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: " username
                
                if id "$username" &>/dev/null; then
                    show_error "Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹"
                else
                    useradd -m -s /bin/bash "$username"
                    passwd "$username"
                    
                    read -p "Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© sudoØŸ (y/n): " add_sudo
                    if [[ "$add_sudo" == "y" ]]; then
                        usermod -aG sudo "$username"
                        echo -e "${G}âœ… ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© sudo${NC}"
                    fi
                    
                    show_success "ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… $username"
                fi
                press_enter
                ;;
            4)
                echo -e "\n${C}ğŸ—‘ï¸ Ø­Ø°Ù Ù…Ø³ØªØ®Ø¯Ù…${NC}"
                read -p "Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: " username
                
                if ! id "$username" &>/dev/null; then
                    show_error "Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯"
                elif [[ "$username" == "root" ]]; then
                    show_error "Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… root"
                else
                    read -p "Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ (y/n): " confirm
                    if [[ "$confirm" == "y" ]]; then
                        pkill -u "$username" 2>/dev/null
                        userdel -r "$username" 2>/dev/null
                        show_success "ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… $username"
                    fi
                fi
                press_enter
                ;;
            5)
                echo -e "\n${C}ğŸ”‘ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±${NC}"
                read -p "Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: " username
                if id "$username" &>/dev/null; then
                    passwd "$username"
                else
                    show_error "Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯"
                fi
                press_enter
                ;;
            6)
                echo -e "\n${C}ğŸ”’ Ø­Ø¸Ø± Ù…Ø³ØªØ®Ø¯Ù…${NC}"
                read -p "Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: " username
                if id "$username" &>/dev/null; then
                    passwd -l "$username"
                    pkill -u "$username" 2>/dev/null
                    show_success "ØªÙ… Ø­Ø¸Ø± $username"
                else
                    show_error "Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯"
                fi
                press_enter
                ;;
            7)
                echo -e "\n${C}ğŸ”“ ÙÙƒ Ø­Ø¸Ø± Ù…Ø³ØªØ®Ø¯Ù…${NC}"
                read -p "Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: " username
                if id "$username" &>/dev/null; then
                    passwd -u "$username"
                    show_success "ØªÙ… ÙÙƒ Ø§Ù„Ø­Ø¸Ø± Ø¹Ù† $username"
                else
                    show_error "Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯"
                fi
                press_enter
                ;;
            0) break ;;
            *) show_error "Ø®ÙŠØ§Ø± ØºÙŠØ± ØµØ§Ù„Ø­"; sleep 1 ;;
        esac
    done
}

# ==================================================
# Ø¥Ø¯Ø§Ø±Ø© Ø´Ø¹Ø§Ø± SSH
# ==================================================
banner_menu() {
    while true; do
        show_banner
        echo -e "${P}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
        echo -e "${P}â•‘           ğŸ¨ Ø¥Ø¯Ø§Ø±Ø© Ø´Ø¹Ø§Ø± SSH                    â•‘${NC}"
        echo -e "${P}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo ""
        
        echo -e "  ${G}[1]${NC} ğŸ“‹ Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø¹Ø§Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ"
        echo -e "  ${G}[2]${NC} âœï¸ Ø¥Ù†Ø´Ø§Ø¡/ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø´Ø¹Ø§Ø±"
        echo -e "  ${G}[3]${NC} ğŸ—‘ï¸ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø´Ø¹Ø§Ø±"
        echo -e "  ${R}[0]${NC} ğŸ”™ Ø±Ø¬ÙˆØ¹"
        echo ""
        read -p "$(echo -e ${Y}"Ø§Ø®ØªØ± Ø±Ù‚Ù… Ø§Ù„Ø®ÙŠØ§Ø±: "${NC})" choice
        
        case $choice in
            1)
                if [ -f /etc/ssh/banner ]; then
                    echo -e "\n${Y}Ø§Ù„Ø´Ø¹Ø§Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ:${NC}"
                    cat /etc/ssh/banner
                else
                    show_warning "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø´Ø¹Ø§Ø±"
                fi
                press_enter
                ;;
            2)
                echo -e "${Y}Ø£Ø¯Ø®Ù„ Ø§Ù„Ù†Øµ Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Ctrl+D Ù„Ù„Ø­ÙØ¸ØŒ Ctrl+C Ù„Ù„Ø¥Ù„ØºØ§Ø¡):${NC}"
                cat > /etc/ssh/banner
                
                # ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø´Ø¹Ø§Ø±
                if ! grep -q "^Banner" /etc/ssh/sshd_config; then
                    echo "Banner /etc/ssh/banner" >> /etc/ssh/sshd_config
                else
                    sed -i 's|^Banner.*|Banner /etc/ssh/banner|' /etc/ssh/sshd_config
                fi
                
                systemctl restart sshd 2>/dev/null || systemctl restart ssh
                show_success "ØªÙ… Ø­ÙØ¸ ÙˆØªÙØ¹ÙŠÙ„ Ø§Ù„Ø´Ø¹Ø§Ø±"
                press_enter
                ;;
            3)
                rm -f /etc/ssh/banner
                sed -i '/^Banner/d' /etc/ssh/sshd_config
                systemctl restart sshd 2>/dev/null || systemctl restart ssh
                show_success "ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø´Ø¹Ø§Ø±"
                press_enter
                ;;
            0) break ;;
            *) show_error "Ø®ÙŠØ§Ø± ØºÙŠØ± ØµØ§Ù„Ø­"; sleep 1 ;;
        esac
    done
}

# ==================================================
# Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª SSH Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©
# ==================================================
advanced_settings() {
    while true; do
        show_banner
        echo -e "${P}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
        echo -e "${P}â•‘           âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª SSH Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©              â•‘${NC}"
        echo -e "${P}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo ""
        
        echo -e "  ${G}[1]${NC} ğŸ” ØªÙØ¹ÙŠÙ„/ØªØ¹Ø·ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø±ÙˆØª"
        echo -e "  ${G}[2]${NC} ğŸ”‘ ØªÙØ¹ÙŠÙ„/ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø¨ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±"
        echo -e "  ${G}[3]${NC} â±ï¸ ØªØºÙŠÙŠØ± Ù…Ù‡Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„"
        echo -e "  ${G}[4]${NC} ğŸ”¢ ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª"
        echo -e "  ${G}[5]${NC} ğŸ“ Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª"
        echo -e "  ${R}[0]${NC} ğŸ”™ Ø±Ø¬ÙˆØ¹"
        echo ""
        read -p "$(echo -e ${Y}"Ø§Ø®ØªØ± Ø±Ù‚Ù… Ø§Ù„Ø®ÙŠØ§Ø±: "${NC})" choice
        
        case $choice in
            1)
                CURRENT=$(grep "^PermitRootLogin" /etc/ssh/sshd_config | awk '{print $2}')
                if [[ "$CURRENT" == "yes" ]]; then
                    sed -i 's/^PermitRootLogin yes/PermitRootLogin no/' /etc/ssh/sshd_config
                    show_success "ØªÙ… ØªØ¹Ø·ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø±ÙˆØª"
                else
                    sed -i 's/^PermitRootLogin no/PermitRootLogin yes/' /etc/ssh/sshd_config
                    show_success "ØªÙ… ØªÙØ¹ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø±ÙˆØª"
                fi
                systemctl restart sshd 2>/dev/null || systemctl restart ssh
                press_enter
                ;;
            2)
                CURRENT=$(grep "^PasswordAuthentication" /etc/ssh/sshd_config | awk '{print $2}')
                if [[ "$CURRENT" == "yes" ]]; then
                    sed -i 's/^PasswordAuthentication yes/PasswordAuthentication no/' /etc/ssh/sshd_config
                    show_success "ØªÙ… ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø¨ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±"
                else
                    sed -i 's/^PasswordAuthentication no/PasswordAuthentication yes/' /etc/ssh/sshd_config
                    show_success "ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø¨ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±"
                fi
                systemctl restart sshd 2>/dev/null || systemctl restart ssh
                press_enter
                ;;
            3)
                read -p "Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ù‡Ù„Ø© Ø¨Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ (60-600): " timeout
                if [[ "$timeout" =~ ^[0-9]+$ ]] && [ "$timeout" -ge 60 ] && [ "$timeout" -le 600 ]; then
                    sed -i "s/^#*LoginGraceTime .*/LoginGraceTime $timeout/" /etc/ssh/sshd_config
                    systemctl restart sshd 2>/dev/null || systemctl restart ssh
                    show_success "ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ù‡Ù„Ø© Ø¥Ù„Ù‰ $timeout Ø«Ø§Ù†ÙŠØ©"
                else
                    show_error "Ù‚ÙŠÙ…Ø© ØºÙŠØ± ØµØ§Ù„Ø­Ø©"
                fi
                press_enter
                ;;
            4)
                read -p "Ø£Ø¯Ø®Ù„ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª (1-10): " attempts
                if [[ "$attempts" =~ ^[0-9]+$ ]] && [ "$attempts" -ge 1 ] && [ "$attempts" -le 10 ]; then
                    sed -i "s/^#*MaxAuthTries .*/MaxAuthTries $attempts/" /etc/ssh/sshd_config
                    systemctl restart sshd 2>/dev/null || systemctl restart ssh
                    show_success "ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ø¥Ù„Ù‰ $attempts"
                else
                    show_error "Ù‚ÙŠÙ…Ø© ØºÙŠØ± ØµØ§Ù„Ø­Ø©"
                fi
                press_enter
                ;;
            5)
                echo -e "\n${C}Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª SSH Ø§Ù„Ø­Ø§Ù„ÙŠØ©:${NC}"
                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                grep -E "^(Port|PermitRootLogin|PasswordAuthentication|Banner|ClientAliveInterval|MaxAuthTries|LoginGraceTime)" /etc/ssh/sshd_config | grep -v "^#"
                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                press_enter
                ;;
            0) break ;;
            *) show_error "Ø®ÙŠØ§Ø± ØºÙŠØ± ØµØ§Ù„Ø­"; sleep 1 ;;
        esac
    done
}

# ==================================================
# Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ
# ==================================================
backup_menu() {
    show_banner
    echo -e "${P}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${P}â•‘           ğŸ’¾ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ                   â•‘${NC}"
    echo -e "${P}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    
    echo -e "  ${G}[1]${NC} Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©"
    echo -e "  ${G}[2]${NC} Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©"
    echo -e "  ${R}[0]${NC} Ø±Ø¬ÙˆØ¹"
    echo ""
    read -p "$(echo -e ${Y}"Ø§Ø®ØªØ± Ø±Ù‚Ù… Ø§Ù„Ø®ÙŠØ§Ø±: "${NC})" choice
    
    case $choice in
        1)
            BACKUP_DIR="/root/ssh-backup-$(date +%Y%m%d-%H%M%S)"
            mkdir -p "$BACKUP_DIR"
            
            cp /etc/ssh/sshd_config "$BACKUP_DIR/"
            [ -f /etc/ssh/banner ] && cp /etc/ssh/banner "$BACKUP_DIR/"
            
            tar -czf "$BACKUP_DIR.tar.gz" "$BACKUP_DIR" 2>/dev/null
            rm -rf "$BACKUP_DIR"
            
            show_success "ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø³Ø®Ø©: $BACKUP_DIR.tar.gz"
            press_enter
            ;;
        2)
            echo -e "\n${C}Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ù…ØªØ§Ø­Ø©:${NC}"
            ls -lh /root/ssh-backup-*.tar.gz 2>/dev/null | awk '{print "  " $9}'
            echo ""
            read -p "Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù: " file
            
            if [ -f "/root/$file" ]; then
                TEMP_DIR="/tmp/ssh-restore-$$"
                mkdir -p "$TEMP_DIR"
                tar -xzf "/root/$file" -C "$TEMP_DIR"
                
                cp "$TEMP_DIR"/*/sshd_config /etc/ssh/sshd_config 2>/dev/null
                cp "$TEMP_DIR"/*/banner /etc/ssh/banner 2>/dev/null
                
                rm -rf "$TEMP_DIR"
                systemctl restart sshd 2>/dev/null || systemctl restart ssh
                show_success "ØªÙ…Øª Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©"
            else
                show_error "Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯"
            fi
            press_enter
            ;;
        0) return ;;
    esac
}

# ==================================================
# Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
# ==================================================
main_menu() {
    while true; do
        show_banner
        echo -e "${P}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
        echo -e "${P}â•‘           ğŸ“Œ Ù‚Ø§Ø¦Ù…Ø© Ø¥Ø¯Ø§Ø±Ø© SSH                   â•‘${NC}"
        echo -e "${P}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo ""
        
        echo -e "  ${G}[1]${NC} ğŸ“Š Ø¥Ø¯Ø§Ø±Ø© Ø®Ø¯Ù…Ø© SSH"
        echo -e "  ${G}[2]${NC} ğŸ”‘ ØªØºÙŠÙŠØ± Ø¨ÙˆØ±Øª SSH"
        echo -e "  ${G}[3]${NC} ğŸ‘¤ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†"
        echo -e "  ${G}[4]${NC} ğŸ¨ Ø¥Ø¯Ø§Ø±Ø© Ø´Ø¹Ø§Ø± SSH"
        echo -e "  ${G}[5]${NC} âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…ØªÙ‚Ø¯Ù…Ø©"
        echo -e "  ${G}[6]${NC} ğŸ’¾ Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ"
        echo -e "  ${R}[0]${NC} ğŸšª Ø®Ø±ÙˆØ¬"
        echo ""
        read -p "$(echo -e ${Y}"Ø§Ø®ØªØ± Ø±Ù‚Ù… Ø§Ù„Ø®ÙŠØ§Ø±: "${NC})" choice
        
        case $choice in
            1) ssh_service_menu ;;
            2) change_ssh_port ;;
            3) user_management ;;
            4) banner_menu ;;
            5) advanced_settings ;;
            6) backup_menu ;;
            0)
                echo -e "\n${G}Ù…Ø¹ Ø§Ù„Ø³Ù„Ø§Ù…Ø©! ğŸ‘‹${NC}"
                exit 0
                ;;
            *) show_error "Ø®ÙŠØ§Ø± ØºÙŠØ± ØµØ§Ù„Ø­"; sleep 1 ;;
        esac
    done
}

# Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬
main_menu